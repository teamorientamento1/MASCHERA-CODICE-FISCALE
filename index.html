<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Maschera Iscrizione – Università di Pisa</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet"/>

  <script src="https://www.google.com/recaptcha/api.js?render=6LfMlcorAAAAAMYoMQ5ACAKP0B3XhfKHfv8zuDTY"></script>

  <style>
    :root {
      --colore-primario-unipi:#003366; --colore-sfondo:#f4f7f6; --colore-testo-secondario:#6c757d;
      --colore-bianco:#ffffff; --colore-ombra:rgba(0,0,0,.08); --errore-bg:#fdecea; --errore-bordo:#e57373;
    }
    *{box-sizing:border-box}
    body{font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;background:var(--colore-sfondo);margin:0;padding:20px}
    .container{background:#fff;padding:32px 28px;border-radius:12px;box-shadow:0 10px 25px var(--colore-ombra);width:100%;max-width:780px;border-top:5px solid var(--colore-primario-unipi)}
    .logo-unipi{max-width:200px;height:auto;margin-bottom:10px;display:block}
    h1{color:var(--colore-primario-unipi);font-weight:700;margin:8px 0 12px}
    p{color:var(--colore-testo-secondario);margin:0 0 20px}
    .section{margin-top:28px;padding-top:20px;border-top:1px solid #e9ecef}
    .section h2{margin:0 0 12px;color:var(--colore-primario-unipi);font-size:1.15rem}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-weight:700;color:#34495e;font-size:.95rem}
    select,input[type="text"],input[type="date"],input[type="tel"],input[type="email"]{font-size:1rem;padding:10px 12px;border:2px solid #dee2e6;border-radius:8px;transition:border-color .2s,box-shadow .2s;background:#fff}
    select:disabled{background:#f1f3f5;color:#8f9aa3;cursor:not-allowed}
    select:focus,input:focus{border-color:var(--colore-primario-unipi);box-shadow:0 0 0 3px rgba(0,51,102,.2);outline:none}
    .help{font-size:.9rem;color:var(--colore-testo-secondario);margin-top:6px}
    .hidden{display:none}
    .cf-input-group input{font-family:'Courier New',Courier,monospace;font-size:1.2em;padding:10px;border:2px solid #dee2e6;border-radius:6px;text-align:center;letter-spacing:2px;text-transform:uppercase;margin:5px;width:70px;transition:border-color .2s,box-shadow .2s}
    .cf-input-group input:focus{border-color:var(--colore-primario-unipi);box-shadow:0 0 0 3px rgba(0,51,102,.2);outline:none}
    #part1{width:60px} #part2{width:80px} #part3{width:40px} #part4{width:80px} #part5{width:60px}
    #submit_button{background:var(--colore-primario-unipi);color:#fff;border:none;padding:12px 30px;border-radius:50px;font-size:1em;font-weight:700;cursor:pointer;margin-top:10px;transition:background-color .2s,transform .2s;text-transform:uppercase}
    #submit_button:hover:not(:disabled){background:#004488;transform:translateY(-2px)}
    #submit_button:disabled{background:#a1a1a1;cursor:not-allowed}
    .invalid{background-color:var(--errore-bg)!important;border-color:var(--errore-bordo)!important}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <img src="images/marchio_unipi_orizz_pant541.png" alt="Logo Università di Pisa" class="logo-unipi"/>
    <h1>Validazione Codice Fiscale</h1>
    <p>Per procedere, inserisci il tuo codice fiscale un pezzo alla volta.</p>

    <!-- BLOCCO CF -->
    <form id="cf_form" novalidate>
      <div class="cf-input-group">
        <input type="text" id="part1" maxlength="3" autocomplete="off"/>
        <input type="text" id="part2" maxlength="4" class="hidden" autocomplete="off"/>
        <input type="text" id="part3" maxlength="2" class="hidden" autocomplete="off"/>
        <input type="text" id="part4" maxlength="4" class="hidden" autocomplete="off"/>
        <input type="text" id="part5" maxlength="3" class="hidden" autocomplete="off"/>
      </div>
      <button type="submit" id="submit_button" disabled>Procedi</button>
      <div class="help">DEV: apri con <code>?dev=1</code> per testare le sezioni successive senza reindirizzo.</div>
    </form>

    <!-- RESIDENZA -->
    <div id="sez-residenza" class="section hidden" aria-hidden="true">
      <h2>Residenza</h2>
      <div class="row">
        <div class="field">
          <label for="res_regione">Regione (residenza)</label>
          <select id="res_regione" disabled>
            <option value="">— Seleziona Regione —</option>
          </select>
        </div>
        <div class="field">
          <label for="res_provincia">Provincia</label>
          <select id="res_provincia" disabled>
            <option value="">— Seleziona Provincia —</option>
          </select>
        </div>
        <div class="field">
          <label for="res_comune">Comune</label>
          <select id="res_comune" disabled>
            <option value="">— Seleziona Comune —</option>
          </select>
        </div>
      </div>
      <div class="help">I menù sono a cascata: prima Regione, poi Provincia, poi Comune.</div>

      <!-- Fallback loader per file:// -->
      <div id="istat_loader" class="help hidden">
        Non riesco a leggere <code>data/comuni_hierarchy.json</code>.  
        Carica manualmente il file:
        <input type="file" id="istat_file" accept="application/json">
      </div>
    </div>
  </div>

  <script>
  const MS_FORM_URL = "https://forms.office.com/Pages/ResponsePage.aspx?id=TUA_LUNGA_STRINGA_QUI";
  const CF_FIELD_ID = "r0a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5";
  const RECAPTCHA_SITE_KEY = "6LfMlcorAAAAAMYoMQ5ACAKP0B3XhfKHfv8zuDTY";
  const DEV_MODE = new URLSearchParams(location.search).get('dev') === '1';

  const risposte = {
    cf: null,
    residenza: { regione:null, provincia:null, provincia_sigla:null, comune:null, codice_catastale:null, codice_istat:null }
  };

  function validaCodiceFiscale(cf){
    if(!cf||cf.length!==16) return false;
    const x=cf.toUpperCase();
    const rx=/^[A-Z]{6}[0-9LMNPQRSTUV]{2}[A-Z][0-9LMNPQRSTUV]{2}[A-Z][0-9LMNPQRSTUV]{3}[A-Z]$/;
    if(!rx.test(x)) return false;
    let s=0;
    const m={'0':1,'1':0,'2':5,'3':7,'4':9,'5':13,'6':15,'7':17,'8':19,'9':21,'A':1,'B':0,'C':5,'D':7,'E':9,'F':13,'G':15,'H':17,'I':19,'J':21,'K':2,'L':4,'M':18,'N':20,'O':11,'P':3,'Q':6,'R':8,'S':12,'T':14,'U':16,'V':10,'W':22,'X':25,'Y':24,'Z':23};
    for(let i=0;i<15;i++){const c=x[i]; if((i+1)%2===0){s+=isNaN(parseInt(c,10))? c.charCodeAt(0)-'A'.charCodeAt(0):parseInt(c,10);} else {s+=m[c];}}
    return x[15]===String.fromCharCode('A'.charCodeAt(0)+(s%26));
  }
  function setInvalid(el,b){ if(!el) return; if(b) el.classList.add('invalid'); else el.classList.remove('invalid'); }
  function sortAlpha(arr){ return arr.slice().sort((a,b)=>a.localeCompare(b,'it',{sensitivity:'base'})); }

  const inputs=[...document.querySelectorAll('.cf-input-group input')];
  const submitButton=document.getElementById('submit_button');
  const form=document.getElementById('cf_form');

  let ultimoCodiceErrato=null, utenteHaModificato=false;

  inputs.forEach((input,idx)=>{
    input.addEventListener('paste',e=>e.preventDefault());
    input.addEventListener('input',()=>{
      utenteHaModificato=true;
      input.value=input.value.toUpperCase();
      if(input.value.length>input.maxLength){input.value=input.value.slice(0,input.maxLength);}
      if(input.value.length===input.maxLength && idx<inputs.length-1){inputs[idx+1].classList.remove('hidden');}
      submitButton.disabled=!inputs.every(i=>i.value.length===i.maxLength);
    });
  });

  form.addEventListener('submit', (event)=>{
    event.preventDefault();
    submitButton.disabled=true;

    const fullCF=inputs.map(i=>i.value).join('');
    const ok=validaCodiceFiscale(fullCF);
    risposte.cf=fullCF;

    if(DEV_MODE){
      if(!ok){ const go=confirm("Il Codice Fiscale inserito non sembra valido. Procedere comunque in DEV?"); if(!go){ submitButton.disabled=false; return; } }
      document.getElementById('sez-residenza').classList.remove('hidden');
      document.getElementById('sez-residenza').setAttribute('aria-hidden','false');
      inizializzaResidenza();
      submitButton.disabled=false;
      return;
    }

    grecaptcha.ready(function(){
      grecaptcha.execute(RECAPTCHA_SITE_KEY,{action:'submit'}).then(function(token){
        function go(){ const finalUrl=`${MS_FORM_URL}&${CF_FIELD_ID}=${encodeURIComponent(fullCF)}`; window.location.href=finalUrl; }
        if(ok){ go(); }
        else{
          if(fullCF===ultimoCodiceErrato && utenteHaModificato){ if(confirm("Il Codice Fiscale inserito non sembra valido. Sei sicuro che sia corretto?")) go(); }
          else { alert("Il Codice Fiscale inserito non è valido. Si prega di controllare."); ultimoCodiceErrato=fullCF; }
        }
        submitButton.disabled=false; utenteHaModificato=false;
      });
    });
  });

  // ------------------- RESIDENZA -------------------
  const selReg=document.getElementById('res_regione');
  const selProv=document.getElementById('res_provincia');
  const selCom=document.getElementById('res_comune');
  let ISTAT_DATA=null;

  function resetSelect(select, placeholder, disabled=true){
    select.innerHTML='';
    const opt=document.createElement('option');
    opt.value=''; opt.textContent=placeholder;
    select.appendChild(opt);
    select.disabled=disabled;
    setInvalid(select,false);
  }
  function popolaSelect(select, values, mapText, mapValue){
    resetSelect(select, select===selProv?'— Seleziona Provincia —':select===selCom?'— Seleziona Comune —':'— Seleziona —', false);
    for(const v of values){
      const opt=document.createElement('option');
      opt.value=mapValue?mapValue(v):v;
      opt.textContent=mapText?mapText(v):v;
      select.appendChild(opt);
    }
  }

  async function tryFetchSequential(paths){
    for(const p of paths){
      try{
        const res = await fetch(p,{cache:'no-store'});
        if(res.ok){
          console.info('Caricato comuni da:', p);
          return await res.json();
        }
      }catch(e){ /* passa al prossimo */ }
    }
    throw new Error('Fetch fallita su tutti i percorsi: '+paths.join(', '));
  }

  async function caricaComuni(){
    if(ISTAT_DATA) return ISTAT_DATA;
    const PATHS = [
      './data/comuni_hierarchy.json',
      'data/comuni_hierarchy.json',
      '../data/comuni_hierarchy.json',
      '/data/comuni_hierarchy.json'
    ];
    try{
      ISTAT_DATA = await tryFetchSequential(PATHS);
      return ISTAT_DATA;
    }catch(err){
      console.warn('Fetch comuni fallita:', err);
      const loader=document.getElementById('istat_loader');
      const fileInput=document.getElementById('istat_file');
      if(loader && fileInput){
        loader.classList.remove('hidden');
        fileInput.addEventListener('change', async (e)=>{
          const file=e.target.files?.[0];
          if(!file) return;
          try{
            const text=await file.text();
            ISTAT_DATA=JSON.parse(text);
            loader.classList.add('hidden');
            inizializzaResidenza(true); // ripopola subito
          }catch(e2){
            alert('Il file selezionato non è un JSON valido.');
          }
        }, {once:true});
      }else{
        alert('Impossibile caricare i dati dei comuni. Verifica il percorso ./data/comuni_hierarchy.json');
      }
      return null;
    }
  }

  async function inizializzaResidenza(forceRepopulate=false){
    const data = await caricaComuni();
    if(!data) return;

    // REGIONI
    const regioni = sortAlpha(Object.keys(data));
    if(forceRepopulate || selReg.options.length<=1){
      resetSelect(selReg,'— Seleziona Regione —', false);
      popolaSelect(selReg, regioni, r=>r, r=>r);
      resetSelect(selProv,'— Seleziona Provincia —', true);
      resetSelect(selCom,'— Seleziona Comune —', true);
    }

    selReg.onchange = () => {
      const regione = selReg.value || null;
      risposte.residenza.regione = regione;
      risposte.residenza.provincia = null;
      risposte.residenza.provincia_sigla = null;
      risposte.residenza.comune = null;
      risposte.residenza.codice_catastale = null;
      risposte.residenza.codice_istat = null;

      if(!regione || !data[regione]){
        resetSelect(selProv,'— Seleziona Provincia —', true);
        resetSelect(selCom,'— Seleziona Comune —', true);
        setInvalid(selReg,true);
        return;
      }
      setInvalid(selReg,false);

      const province = sortAlpha(Object.keys(data[regione]));
      popolaSelect(selProv, province, p=>{
        const sigla = data[regione][p]?.sigla ? ` (${data[regione][p].sigla})` : '';
        return `${p}${sigla}`;
      }, p=>p);
      resetSelect(selCom,'— Seleziona Comune —', true);
    };

    selProv.onchange = () => {
      const regione = selReg.value;
      const prov = selProv.value || null;

      risposte.residenza.provincia = prov;
      risposte.residenza.provincia_sigla = prov && data[regione][prov] ? data[regione][prov].sigla || null : null;
      risposte.residenza.comune = null;
      risposte.residenza.codice_catastale = null;
      risposte.residenza.codice_istat = null;

      if(!prov || !data[regione] || !data[regione][prov]){
        resetSelect(selCom,'— Seleziona Comune —', true);
        setInvalid(selProv,true);
        return;
      }
      setInvalid(selProv,false);

      const comuni = sortAlpha((data[regione][prov].comuni || []).map(c=>c.nome));
      popolaSelect(selCom, comuni, c=>c, c=>c);
    };

    selCom.onchange = () => {
      const regione = selReg.value;
      const prov = selProv.value;
      const comuneNome = selCom.value || null;

      if(!comuneNome || !data[regione] || !data[regione][prov]){
        setInvalid(selCom,true);
        risposte.residenza.comune = null;
        risposte.residenza.codice_catastale = null;
        risposte.residenza.codice_istat = null;
        return;
      }
      const rec = (data[regione][prov].comuni || []).find(c=>c.nome===comuneNome);
      if(!rec){
        setInvalid(selCom,true);
        risposte.residenza.comune = null;
        risposte.residenza.codice_catastale = null;
        risposte.residenza.codice_istat = null;
        return;
      }
      setInvalid(selCom,false);
      risposte.residenza.comune = comuneNome;
      risposte.residenza.codice_catastale = rec.codice_catastale || null;
      risposte.residenza.codice_istat = rec.codice_istat || null;
    };

    selReg.disabled=false;
  }
  </script>
</body>
</html>
